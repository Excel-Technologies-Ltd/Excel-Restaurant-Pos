var B=(E,T,p)=>new Promise((O,o)=>{var y=h=>{try{v(p.next(h))}catch(g){o(g)}},u=h=>{try{v(p.throw(h))}catch(g){o(g)}},v=h=>h.done?O(h.value):Promise.resolve(h.value).then(y,u);v((p=p.apply(E,T)).next())});import{r as x,f as Q,H as Y,g as G,F as W,K as te,j as e,L as ae,h as ne,i as ce,_ as C,e as le,Z as oe}from"./index-BpliADP0.js";const de=[{item_code:"item1",item_name:"Coffee Mug",price:250,quantity:1,isParcel:!1},{item_code:"item2",item_name:"Tea Pot",price:500,quantity:2,isParcel:!0}],re=({orderId:E,closeModal:T})=>{var K;const[p,O]=x.useState(0);x.useState(de);const[o,y]=x.useState([]);x.useState({item1:1,item2:2}),x.useState("");const[u,v]=x.useState("percentage"),[h,g]=x.useState(""),[w,m]=x.useState(""),[S,j]=x.useState(""),{data:c}=Q("Table Order",E);console.log({order:c});const{updateDoc:$}=Y(),{currentUser:q}=G(),{data:F}=W(`excel_restaurant_pos.api.item.get_roles?user=${q}`),f=(K=F==null?void 0:F.message)==null?void 0:K.map(s=>s==null?void 0:s.Role);console.log("userRoles",f);const{data:b,error:L}=Q("Restaurant Settings","Restaurant Settings",{fields:["*"]}),{call:I}=te("excel_restaurant_pos.api.item.check_coupon_code"),t=parseInt((b==null?void 0:b.tax_rate)||"0")/100,r=20,l=o==null?void 0:o.reduce((s,a)=>s+Number(a.rate)*a.qty,0),D=s=>{const a=o.findIndex(n=>n.name===s);if(a!==-1){const n=[...o];n[a].qty?n[a].qty+=1:n[a].qty=1,y(n)}},d=s=>{const a=o.findIndex(n=>n.name===s);if(a!==-1){const n=[...o];n[a].qty&&n[a].qty>1?n[a].qty-=1:n[a].qty=1,y(n)}},i=s=>{const a=o.filter(n=>n.name!==s);y(a)},P=s=>{const a=s.target.value;if(u==="percentage"){const n=Number(a),N=l*(Number(a)/100);if(a&&(n<0||n>100)){m("Discount must be between 0 and 100.");return}if(N>=l){m("Discount cannot be greater than the total amount.");return}else{m(""),j(a);return}}if(u==="flat")if(a&&Number(a)<0)m("Flat discount cannot be negative.");else if(Number(a)>p){m(`Discount cannot be greater than ${p}.`);return}else if(Number(a)>=l){m("Discount cannot be greater than the total amount.");return}else m(""),j(a);else m(""),j("")},k=s=>{g(s.target.value)},_=()=>{switch(u){case"percentage":return"percentage";case"flat":return"flat amount";case"coupon":return"coupon code";default:return""}},J=s=>{C.success(u),v(s.target.value),C.success(u),j(""),m("")},X=s=>{const a=o.findIndex(n=>n.name===s);if(a!==-1){const n=[...o];n[a].is_parcel=!n[a].is_parcel,y(n)}},ee=()=>{const s={item_list:o,discount:M,discount_type:u,status:"Completed",is_paid:1};$("Table Order",E,s).then(a=>{a&&(C.success("success"),T())}).catch(a=>{C.error("Error updating order status."),console.log("Error updating order status:",a)}),console.log({payload:s})},se=()=>{h&&I({data:{coupon_code:h}}).then(s=>{var a,n,N,A,V,Z,z;((a=s==null?void 0:s.message)==null?void 0:a.status)==="success"?(console.log("res",s==null?void 0:s.message),m(""),R=((n=s==null?void 0:s.message)==null?void 0:n.discount_type)==="percentage"?l*Number((A=(N=s==null?void 0:s.message)==null?void 0:N.amount)!=null?A:0)/100:Number((Z=(V=s==null?void 0:s.message)==null?void 0:V.amount)!=null?Z:0),j(String(R)),g("")):(m((z=s==null?void 0:s.message)==null?void 0:z.message),j(""))})};let R=u==="percentage"?l*Number(S)/100>p?p:l*Number(S)/100:Number(S);const M=R>0?R:c==null?void 0:c.discount,U=(l-M)*t,H=l-M+U;return console.log({orderItems:o}),x.useEffect(()=>{c&&y(c==null?void 0:c.item_list)},[c]),x.useEffect(()=>{const s=a=>{var n;if(b!=null&&b.discount_allocation){const N=(n=b==null?void 0:b.discount_allocation)==null?void 0:n.find(A=>(A==null?void 0:A.role)===a);if(N&&(N==null?void 0:N.amount)>0)return O(N==null?void 0:N.amount),!0}return!1};f!=null&&f.includes("Restaurant Manager")&&s("Restaurant Manager")||f!=null&&f.includes("Restaurant Cashier")&&s("Restaurant Cashier")||f!=null&&f.includes("Restaurant Waiter")&&s("Restaurant Waiter")},[f,b==null?void 0:b.discount_allocation]),e.jsx("div",{className:"fixed inset-0 flex justify-center items-center bg-black bg-opacity-50 z-50",children:e.jsxs("div",{className:"bg-white md:p-2 pb-3 rounded-md shadow-lg w-96",children:[e.jsx("h1",{className:"text-sm font-semibold mb-2",children:"Cart Summary"}),(o==null?void 0:o.length)>0?e.jsx("div",{className:"text-xs",children:o==null?void 0:o.map(s=>{var a,n;return e.jsx("div",{className:"accordion mb-1",children:e.jsx("div",{className:"border rounded-md p-2",children:e.jsxs("div",{className:"flex justify-between items-center transition font-medium",children:[e.jsxs("div",{className:"block w-1/3",children:[e.jsxs("p",{title:s==null?void 0:s.item,className:"font-semibold truncate",children:[((a=s==null?void 0:s.item)!=null?a:"").substring(0,r),((n=s==null?void 0:s.item_name)==null?void 0:n.length)>r?"...":""]}),e.jsxs("p",{className:"font-semibold mt-1",children:["৳",s==null?void 0:s.rate]})]}),e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs("label",{className:"flex items-center text-xs",children:[e.jsx("input",{type:"checkbox",checked:s==null?void 0:s.is_parcel,className:"mr-2",onChange:()=>X(s==null?void 0:s.name)}),"Parcel"]})}),e.jsxs("div",{className:"flex items-center gap-2 w-1/3",children:[e.jsxs("div",{className:"flex items-center rounded-md h-fit border w-full",children:[e.jsx("button",{onClick:()=>d(s==null?void 0:s.name),className:"px-2 rounded-md rounded-e-none text-xs bg-gray-200 h-fit py-1.5",children:e.jsx(ae,{className:"text-xs"})}),e.jsx("span",{className:"px-2 text-xs h-full flex items-center",children:s==null?void 0:s.qty}),e.jsx("button",{onClick:()=>D(s==null?void 0:s.name),className:"px-2 rounded-md rounded-s-none bg-gray-200 h-fit py-1.5",children:e.jsx(ne,{className:"text-xs"})})]}),e.jsx("button",{onClick:()=>i(s==null?void 0:s.name),className:"text-red-500 px-2 rounded-md text-xs bg-gray-200 h-fit py-1.5 border",children:e.jsx(ce,{})})]})]})})},s==null?void 0:s.name)})}):e.jsx("div",{className:"flex items-center justify-center min-h-28 border border-borderColor rounded-md text-xs",children:"No item in cart"}),e.jsxs("div",{className:"py-4 flex flex-col items-start",children:[e.jsx("h3",{className:"font-semibold text-sm mb-1",children:"Discount"}),(c==null?void 0:c.discount)>0&&e.jsxs("p",{className:"text-xs text-green-500",children:["Applied: ৳",c==null?void 0:c.discount]}),e.jsxs("div",{className:"flex gap-2 w-full text-sm relative",children:[e.jsxs("select",{value:u,onChange:J,className:"border rounded-md p-1 focus:outline-none px-2",children:[e.jsx("option",{value:"percentage",children:"Percentage"}),e.jsx("option",{value:"flat",children:"Flat Amount"}),e.jsx("option",{value:"coupon",children:"Coupon"})]}),e.jsx("input",{type:u==="coupon"?"text":"number",value:u==="coupon"?h:S,onChange:u==="coupon"?k:P,className:`border rounded-md p-1 focus:outline-none px-3 w-full ${w?"border-red-500":""}`,placeholder:`Enter ${_()}`}),w&&e.jsx("p",{className:"text-red-500 text-xs right-0 -bottom-5 pt-2 absolute",children:w}),u==="coupon"&&e.jsx("button",{onClick:se,className:"absolute right-3 top-1  px-2 py-1 bg-blue-500 text-xs text-white rounded-md hover:bg-blue-600",children:"Verify"})]})]}),e.jsxs("div",{className:"p-3 border rounded-md mt-5",children:[e.jsxs("div",{className:"flex justify-between text-xs",children:[e.jsx("h1",{children:"Subtotal"}),e.jsxs("h1",{children:["৳",l.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-xs mt-2",children:[e.jsx("h1",{children:"Discount"}),e.jsxs("h1",{children:["৳",R>0?R==null?void 0:R.toFixed(2):c==null?void 0:c.discount]})]}),e.jsxs("div",{className:"flex justify-between text-xs mt-2",children:[e.jsxs("h1",{children:["Tax (",t*100,"%)"]}),e.jsxs("h1",{children:["৳",U.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-xs font-semibold mt-2",children:[e.jsx("h1",{children:"Payable Amount"}),e.jsxs("h1",{children:["৳",H||(c==null?void 0:c.total_amount)]})]})]}),e.jsxs("div",{className:"flex justify-between gap-3 ",children:[e.jsx("button",{onClick:T,className:"bg-primaryColor text-white w-full p-2 rounded-md mt-3 text-sm",children:"Cancel"}),e.jsx("button",{onClick:ee,className:"bg-primaryColor text-white w-full p-2 rounded-md mt-3 text-sm",children:"Checkout"})]})]})})},xe=()=>{var I;const{currentUser:E}=G(),[T,p]=x.useState(!1),[O,o]=x.useState(""),[y,u]=x.useState(0),{data:v}=W(`excel_restaurant_pos.api.item.get_roles?user=${E}`),h=(I=v==null?void 0:v.message)==null?void 0:I.map(t=>t==null?void 0:t.Role),g=[{id:1,state:"Order Placed",action:"Accept",nextState:"Work in progress",allowed:"Restaurant Waiter"},{id:2,state:"Order Placed",action:"Reject",nextState:"Canceled",allowed:"Restaurant Waiter"},{id:4,state:"Work in progress",action:"Reject",nextState:"Canceled",allowed:"Restaurant Chef"},{id:5,state:"Ready to Serve",action:"Pay Now",nextState:"Completed",allowed:"Restaurant Manager"},{id:6,state:"Ready to Serve",action:"Pay Now",nextState:"Completed",allowed:"Restaurant Cashier"}],[w,m]=x.useState(""),{data:S,mutate:j}=W(`excel_restaurant_pos.api.item.get_order_list?status=${w?encodeURIComponent(w):""}`,["*"]),c=S==null?void 0:S.message,$=(t,r)=>g==null?void 0:g.filter(l=>(l==null?void 0:l.state)===t&&(r==null?void 0:r.includes(l==null?void 0:l.allowed))),{updateDoc:q}=Y(),F=(t,r,l,D)=>{r==="Ready to Serve"?(o(t),p(!0)):f(t,r,l,D)},f=(t,r,l,D)=>{const d=g==null?void 0:g.find(i=>(i==null?void 0:i.state)===r&&(l==null?void 0:l.includes(i==null?void 0:i.allowed))&&(i==null?void 0:i.action)===D);if(d){const i=d.nextState,P={status:i};i==="Completed"&&(P.docstatus=1),q("Table Order",t,P).then(k=>{k&&(C.success("Order status updated successfully!"),j())}).catch(k=>{C.error("Error updating order status."),console.log("Error updating order status:",k)})}else C.error("Invalid transition for the current state and role.")},b=()=>B(void 0,null,function*(){if(y<0||y>100){C.error("Please enter a valid discount between 0 and 100.");return}const t={status:"Completed",discount:y,docstatus:1};try{yield q("Table Order",O,t),C.success("Order completed and discount applied!"),p(!1),j()}catch(r){C.error("Error completing order with discount."),console.log("Error:",r)}}),L=t=>{const r=["bg-gray-100","bg-blue-100","bg-green-100","bg-yellow-100","bg-pink-100"];return r[t%r.length]};return le("Table Order",()=>{j(),console.log("Order List Updated")}),oe("Table Order","on_update",t=>{j(),console.log("Event data:",t)}),x.useEffect(()=>{j()},[w,j]),e.jsxs("div",{className:"p-6 bg-white shadow-md rounded-lg",children:[e.jsx("h2",{className:"font-semibold text-2xl text-gray-800 mb-6",children:"Orders"}),e.jsxs("div",{className:"mb-4",children:[["Order Placed","Work in progress","Ready to Serve","Completed","Canceled"].map(t=>e.jsxs("label",{className:"inline-flex items-center mr-4",children:[e.jsx("input",{type:"checkbox",checked:w===t,onChange:()=>m(w===t?"":t),className:"form-checkbox"}),e.jsx("span",{className:"ml-2",children:t})]},t)),e.jsx("button",{onClick:()=>m(""),className:"ml-4 bg-gray-300 text-gray-700 py-2 px-4 rounded",children:"Reset"})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"table-auto w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-200 text-gray-700 text-left",children:[e.jsx("th",{className:"px-4 py-2 border-b",children:"Order ID"}),e.jsx("th",{className:"px-4 py-2 border-b",children:"Table"}),e.jsx("th",{className:"px-4 py-2 border-b",children:"Status"}),e.jsx("th",{className:"px-4 py-2 border-b",children:"Total Amount"}),e.jsx("th",{className:"px-4 py-2 border-b",children:"Item Name"}),e.jsx("th",{className:"px-4 py-2 border-b",children:"QTY"}),e.jsx("th",{className:"px-4 py-2 border-b",children:"Rate"}),e.jsx("th",{className:"px-4 py-2 border-b",children:"Amount"}),e.jsx("th",{className:"px-4 py-2 border-b",children:" Item Status"}),e.jsx("th",{className:"px-4 py-2 border-b",children:"Delivery Status "}),e.jsx("th",{className:"px-4 py-2 border-b",children:"Action"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-300",children:[" ",c==null?void 0:c.map((t,r)=>{var D;const l=L(r);return e.jsxs(e.Fragment,{children:[(D=t==null?void 0:t.item_list)==null?void 0:D.map((d,i)=>{var P,k;return e.jsxs("tr",{className:`${l}  hover:bg-gray-50`,children:[i===0?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"px-4 py-2 border-b",children:t==null?void 0:t.name}),e.jsx("td",{className:"px-4 py-2 border-b",children:(t==null?void 0:t.table)||"Parcel Order"}),e.jsx("td",{className:"px-4 py-2 border-b",children:t==null?void 0:t.status}),e.jsx("td",{className:"px-4 py-2 border-b",children:(P=t==null?void 0:t.total_amount)==null?void 0:P.toFixed(2)})]}):e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"px-4 py-2 border-b"}),e.jsx("td",{className:"px-4 py-2 border-b"}),e.jsx("td",{className:"px-4 py-2 border-b"}),e.jsx("td",{className:"px-4 py-2 border-b"})]}),e.jsx("td",{className:"px-4 py-2 border-b",children:d==null?void 0:d.item}),e.jsx("td",{className:"px-4 py-2 border-b",children:d==null?void 0:d.qty}),e.jsx("td",{className:"px-4 py-2 border-b",children:d==null?void 0:d.rate}),e.jsx("td",{className:"px-4 py-2 border-b",children:d==null?void 0:d.amount}),e.jsx("td",{className:"px-4 py-2 border-b",children:d!=null&&d.is_parcel?"Parcel":"Dining"}),e.jsx("td",{className:"px-4 py-2 border-b",children:d!=null&&d.is_ready?"Ready":"Not Ready"}),i===0?e.jsx("td",{className:"px-4 py-2  flex gap-3",children:(k=$(t==null?void 0:t.status,h))==null?void 0:k.map(_=>e.jsx("button",{onClick:()=>F(t==null?void 0:t.name,t==null?void 0:t.status,h,_==null?void 0:_.action),className:" bg-primaryColor text-white py-1.5 px-4 rounded",children:_==null?void 0:_.action},_.action))}):e.jsx("td",{})]},`${t.name}-${i}`)}),e.jsx("tr",{className:`${l}`,children:e.jsx("td",{colSpan:11,className:"h-5"})})]})})]})]})}),T&&e.jsxs("div",{className:"fixed inset-0 bg-gray-500 bg-opacity-50 flex justify-center items-center",children:[e.jsxs("div",{className:"bg-white p-6 rounded-lg w-96",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Set Discount for Completed Order"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"discount",className:"block text-sm font-medium text-gray-700",children:"Discount (%)"}),e.jsx("input",{id:"discount",type:"number",min:"0",max:"100",value:y,onChange:t=>u(Number(t.target.value)),className:"mt-2 block w-full px-4 py-2 border border-gray-300 rounded-md"})]}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx("button",{onClick:()=>p(!1),className:"bg-gray-300 text-gray-700 py-2 px-4 rounded",children:"Cancel"}),e.jsx("button",{onClick:b,className:"bg-primaryColor text-white py-2 px-4 rounded",children:"Apply Discount"})]})]}),O&&e.jsx(re,{orderId:O,closeModal:()=>p(!1)})]})]})};export{xe as default};
